name: .NET CI/CD Pipeline

 

on:

  push:

    branches: [ "master", "develop", "claude/**" ]

  pull_request:

    branches: [ "master", "develop" ]

  workflow_dispatch:

 

env:

  DOTNET_VERSION: '9.0.x'

  SOLUTION_PATH: './Booksy.sln'

 

jobs:

  # Job 1: Build and Unit Tests

  build-and-test:

    name: Build & Unit Tests

    runs-on: ubuntu-latest

 

    steps:

    - name: Checkout code

      uses: actions/checkout@v4

      with:

        fetch-depth: 0  # Shallow clones should be disabled for better analysis

 

    - name: Setup .NET

      uses: actions/setup-dotnet@v4

      with:

        dotnet-version: ${{ env.DOTNET_VERSION }}

 

    - name: Cache NuGet packages

      uses: actions/cache@v4

      with:

        path: ~/.nuget/packages

        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}

        restore-keys: |

          ${{ runner.os }}-nuget-

 

    - name: Restore dependencies

      run: dotnet restore ${{ env.SOLUTION_PATH }}

 

    - name: Build solution

      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

 

    - name: Run Unit Tests

      run: |

        dotnet test ${{ env.SOLUTION_PATH }} \

          --configuration Release \

          --no-build \

          --filter "FullyQualifiedName~UnitTests" \

          --verbosity normal \

          --logger "trx;LogFileName=unit-tests.trx" \

          --collect:"XPlat Code Coverage" \

          --results-directory ./TestResults/UnitTests

 

    - name: Upload Unit Test Results

      uses: actions/upload-artifact@v4

      if: always()

      with:

        name: unit-test-results

        path: ./TestResults/UnitTests/*.trx

 

    - name: Upload Code Coverage

      uses: actions/upload-artifact@v4

      if: always()

      with:

        name: code-coverage

        path: ./TestResults/UnitTests/**/coverage.cobertura.xml

 

  # Job 2: Integration Tests

  integration-tests:

    name: Integration Tests

    runs-on: ubuntu-latest

    needs: build-and-test

 

    services:

      sqlserver:

        image: mcr.microsoft.com/mssql/server:2022-latest

        env:

          ACCEPT_EULA: Y

          SA_PASSWORD: YourStrong@Passw0rd

          MSSQL_PID: Developer

        ports:

          - 1433:1433

        options: >-

          --health-cmd "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -Q 'SELECT 1' || exit 1"

          --health-interval 10s

          --health-timeout 5s

          --health-retries 5

 

      redis:

        image: redis:7-alpine

        ports:

          - 6379:6379

        options: >-

          --health-cmd "redis-cli ping"

          --health-interval 10s

          --health-timeout 5s

          --health-retries 5

 

    steps:

    - name: Checkout code

      uses: actions/checkout@v4

 

    - name: Setup .NET

      uses: actions/setup-dotnet@v4

      with:

        dotnet-version: ${{ env.DOTNET_VERSION }}

 

    - name: Cache NuGet packages

      uses: actions/cache@v4

      with:

        path: ~/.nuget/packages

        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}

        restore-keys: |

          ${{ runner.os }}-nuget-

 

    - name: Restore dependencies

      run: dotnet restore ${{ env.SOLUTION_PATH }}

 

    - name: Build solution

      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

 

    - name: Run Integration Tests

      env:

        ConnectionStrings__DefaultConnection: "Server=localhost,1433;Database=BooksyTest;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;"

        ConnectionStrings__Redis: "localhost:6379"

      run: |

        dotnet test ${{ env.SOLUTION_PATH }} \

          --configuration Release \

          --no-build \

          --filter "FullyQualifiedName~IntegrationTests" \

          --verbosity normal \

          --logger "trx;LogFileName=integration-tests.trx" \

          --collect:"XPlat Code Coverage" \

          --results-directory ./TestResults/IntegrationTests

 

    - name: Upload Integration Test Results

      uses: actions/upload-artifact@v4

      if: always()

      with:

        name: integration-test-results

        path: ./TestResults/IntegrationTests/*.trx

 

  # Job 3: Architecture Tests

  architecture-tests:

    name: Architecture Tests

    runs-on: ubuntu-latest

    needs: build-and-test

 

    steps:

    - name: Checkout code

      uses: actions/checkout@v4

 

    - name: Setup .NET

      uses: actions/setup-dotnet@v4

      with:

        dotnet-version: ${{ env.DOTNET_VERSION }}

 

    - name: Cache NuGet packages

      uses: actions/cache@v4

      with:

        path: ~/.nuget/packages

        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}

        restore-keys: |

          ${{ runner.os }}-nuget-

 

    - name: Restore dependencies

      run: dotnet restore ${{ env.SOLUTION_PATH }}

 

    - name: Build solution

      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

 

    - name: Run Architecture Tests

      run: |

        dotnet test ${{ env.SOLUTION_PATH }} \

          --configuration Release \

          --no-build \

          --filter "FullyQualifiedName~ArchitectureTests" \

          --verbosity normal \

          --logger "trx;LogFileName=architecture-tests.trx" \

          --results-directory ./TestResults/ArchitectureTests

 

    - name: Upload Architecture Test Results

      uses: actions/upload-artifact@v4

      if: always()

      with:

        name: architecture-test-results

        path: ./TestResults/ArchitectureTests/*.trx

 

  # Job 4: Code Quality & Security Analysis

  code-quality:

    name: Code Quality & Security

    runs-on: ubuntu-latest

    needs: build-and-test

 

    steps:

    - name: Checkout code

      uses: actions/checkout@v4

      with:

        fetch-depth: 0

 

    - name: Setup .NET

      uses: actions/setup-dotnet@v4

      with:

        dotnet-version: ${{ env.DOTNET_VERSION }}

 

    - name: Cache NuGet packages

      uses: actions/cache@v4

      with:

        path: ~/.nuget/packages

        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}

        restore-keys: |

          ${{ runner.os }}-nuget-

 

    - name: Restore dependencies

      run: dotnet restore ${{ env.SOLUTION_PATH }}

 

    - name: Build solution

      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration Release --no-restore

 

    - name: Run dotnet format check

      run: dotnet format ${{ env.SOLUTION_PATH }} --verify-no-changes --verbosity diagnostic

      continue-on-error: true

 

    - name: Security Scan with dotnet list package

      run: |

        dotnet list ${{ env.SOLUTION_PATH }} package --vulnerable --include-transitive 2>&1 | tee security-scan.log

      continue-on-error: true

 

    - name: Upload Security Scan Results

      uses: actions/upload-artifact@v4

      if: always()

      with:

        name: security-scan-results

        path: security-scan.log

 

  # Job 5: Docker Build (optional - only if Dockerfiles exist)

  docker-build:

    name: Docker Build

    runs-on: ubuntu-latest

    needs: [build-and-test, integration-tests, architecture-tests]

    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')

 

    steps:

    - name: Checkout code

      uses: actions/checkout@v4

 

    - name: Set up Docker Buildx

      uses: docker/setup-buildx-action@v3

 

    - name: Check for Dockerfiles

      id: check_dockerfiles

      run: |

        if [ -f "docker-compose.yml" ] || [ -f "Dockerfile" ]; then

          echo "has_docker=true" >> $GITHUB_OUTPUT

        else

          echo "has_docker=false" >> $GITHUB_OUTPUT

        fi

 

    - name: Build Docker Compose

      if: steps.check_dockerfiles.outputs.has_docker == 'true'

      run: |

        if [ -f "docker-compose.yml" ]; then

          docker-compose build

        fi

      continue-on-error: true

 

  # Job 6: Test Summary Report

  test-summary:

    name: Test Summary

    runs-on: ubuntu-latest

    needs: [build-and-test, integration-tests, architecture-tests]

    if: always()

 

    steps:

    - name: Download Unit Test Results

      uses: actions/download-artifact@v4

      with:

        name: unit-test-results

        path: ./TestResults/UnitTests

      continue-on-error: true

 

    - name: Download Integration Test Results

      uses: actions/download-artifact@v4

      with:

        name: integration-test-results

        path: ./TestResults/IntegrationTests

      continue-on-error: true

 

    - name: Download Architecture Test Results

      uses: actions/download-artifact@v4

      with:

        name: architecture-test-results

        path: ./TestResults/ArchitectureTests

      continue-on-error: true

 

    - name: Publish Test Results

      uses: EnricoMi/publish-unit-test-result-action@v2

      if: always()

      with:

        files: |

          ./TestResults/**/*.trx

        check_name: Test Results

        comment_mode: off
